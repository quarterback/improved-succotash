<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Intelligence | Occupant</title>
    <meta name="description" content="LLM market intelligence - Quality-Adjusted Price, Cognitive Arbitrage, and tier analysis.">
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="container">
        <nav>
            <a href="/">$CPI Index</a>
            <a href="/sabermetrics.html" class="active">Market Intel</a>
            <a href="/glossary.html">Glossary</a>
            <a href="/about.html">About</a>
            <div class="nav-right">
                <button id="theme-toggle" class="theme-toggle">Light</button>
            </div>
        </nav>

        <header>
            <h1>Market Intelligence</h1>
            <p class="subtitle">Derived statistics for LLM market analysis</p>
        </header>

        <!-- Summary Stats -->
        <section class="card">
            <div class="section-header">
                <div class="section-title">Market Summary</div>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="models-count">-</div>
                    <div class="stat-label">Models Tracked</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avg-arbitrage">-</div>
                    <div class="stat-label">Avg Arbitrage</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="value-spread">-</div>
                    <div class="stat-label">Value Spread</div>
                </div>
            </div>
        </section>

        <!-- Tier Analysis -->
        <section class="card">
            <div class="section-header">
                <div class="section-title">Tier Analysis</div>
                <div class="section-subtitle">Average price and quality by tier</div>
            </div>
            <div class="tier-grid" id="tier-grid">
                <!-- Populated by JS -->
            </div>
        </section>

        <!-- Arbitrage Opportunities -->
        <section class="card">
            <div class="section-header">
                <div class="section-title">Cognitive Arbitrage</div>
                <div class="section-subtitle">Models priced above or below their capability suggests</div>
            </div>
            <table class="leaders-table">
                <thead>
                    <tr>
                        <th>Model</th>
                        <th>Arbitrage</th>
                        <th>Signal</th>
                        <th>Price</th>
                        <th>ELO</th>
                    </tr>
                </thead>
                <tbody id="arbitrage-table">
                    <!-- Populated by JS -->
                </tbody>
            </table>
        </section>

        <!-- Value Leaders -->
        <section class="card">
            <div class="section-header">
                <div class="section-title">Value Leaders</div>
                <div class="section-subtitle">Lowest Quality-Adjusted Price (QAP)</div>
            </div>
            <table class="leaders-table">
                <thead>
                    <tr>
                        <th>Model</th>
                        <th>QAP</th>
                        <th>Price</th>
                        <th>ELO</th>
                    </tr>
                </thead>
                <tbody id="value-table">
                    <!-- Populated by JS -->
                </tbody>
            </table>
        </section>

        <!-- Rankings Data -->
        <section class="card">
            <div class="section-header">
                <div class="section-title">Market Volume</div>
                <div class="section-subtitle">Weekly token volume from OpenRouter</div>
            </div>
            <table class="leaders-table">
                <thead>
                    <tr>
                        <th>Model</th>
                        <th>Volume</th>
                        <th>Share</th>
                    </tr>
                </thead>
                <tbody id="volume-table">
                    <!-- Populated by JS -->
                </tbody>
            </table>
        </section>

        <footer>
            <div>Data from OpenRouter, Arena Leaderboard</div>
            <div class="last-updated">Last updated: <span id="last-updated">-</span></div>
            <div style="margin-top: 1rem;">
                <a href="/glossary.html">What do these metrics mean?</a>
            </div>
        </footer>
    </div>

    <script src="/theme.js"></script>
    <script>
        async function loadMarketData() {
            try {
                const response = await fetch('/data/market/latest.json');
                const data = await response.json();

                // Summary stats
                document.getElementById('models-count').textContent = data.models_analyzed || '-';

                // Calculate avg arbitrage from opportunities
                if (data.arbitrage_opportunities && data.arbitrage_opportunities.length > 0) {
                    const avg = data.arbitrage_opportunities.reduce((sum, a) => sum + a.arbitrage, 0) / data.arbitrage_opportunities.length;
                    document.getElementById('avg-arbitrage').textContent = avg.toFixed(2);
                }

                // Value spread (highest QAP - lowest QAP)
                if (data.value_leaders && data.value_leaders.length > 0) {
                    const qaps = data.value_leaders.map(v => v.qap);
                    const spread = (Math.max(...qaps) / Math.min(...qaps)).toFixed(1) + 'x';
                    document.getElementById('value-spread').textContent = spread;
                }

                // Tier analysis
                const tierGrid = document.getElementById('tier-grid');
                tierGrid.innerHTML = '';

                const tierOrder = ['budget', 'general', 'frontier', 'reasoning', 'longctx'];
                const tierLabels = {
                    'budget': '$BULK',
                    'general': '$GEN',
                    'frontier': '$FRONT',
                    'reasoning': '$REASON',
                    'longctx': '$LCTX'
                };

                const maxPrice = Math.max(...Object.values(data.tier_analysis).map(t => t.avg_price_mtok));

                for (const tier of tierOrder) {
                    if (data.tier_analysis[tier]) {
                        const t = data.tier_analysis[tier];
                        const barWidth = (t.avg_price_mtok / maxPrice) * 100;

                        const row = document.createElement('div');
                        row.className = 'tier-row';
                        row.innerHTML = `
                            <div class="tier-name">${tierLabels[tier] || tier}</div>
                            <div class="tier-bar"><div class="tier-bar-fill" style="width: ${barWidth}%"></div></div>
                            <div class="tier-price">$${t.avg_price_mtok.toFixed(2)}/MTok</div>
                            <div class="tier-elo">ELO ${t.avg_elo || '-'}</div>
                        `;
                        tierGrid.appendChild(row);
                    }
                }

                // Arbitrage table
                const arbTable = document.getElementById('arbitrage-table');
                arbTable.innerHTML = '';

                for (const a of (data.arbitrage_opportunities || [])) {
                    const signalClass = a.arbitrage > 1.2 ? 'buy' : a.arbitrage < 0.8 ? 'sell' : 'fair';
                    const signalText = a.arbitrage > 1.2 ? 'BUY' : a.arbitrage < 0.8 ? 'SELL' : 'FAIR';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="model-name">${a.model.split('/').pop()}</td>
                        <td class="value-cell">${a.arbitrage.toFixed(2)}</td>
                        <td><span class="signal ${signalClass}">${signalText}</span></td>
                        <td class="value-cell">$${a.blended_cost.toFixed(2)}</td>
                        <td class="value-cell">${a.arena_elo || '-'}</td>
                    `;
                    arbTable.appendChild(row);
                }

                // Value leaders table
                const valueTable = document.getElementById('value-table');
                valueTable.innerHTML = '';

                for (const v of (data.value_leaders || [])) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="model-name">${v.model.split('/').pop()}</td>
                        <td class="value-cell">${v.qap.toFixed(2)}</td>
                        <td class="value-cell">$${v.blended_cost.toFixed(2)}/MTok</td>
                        <td class="value-cell">${v.arena_elo || '-'}</td>
                    `;
                    valueTable.appendChild(row);
                }

                // Last updated
                if (data.generated_at) {
                    const date = new Date(data.generated_at);
                    document.getElementById('last-updated').textContent = date.toISOString().split('T')[0];
                }

            } catch (error) {
                console.log('Market data not available:', error);
            }
        }

        async function loadRankingsData() {
            try {
                const response = await fetch('/data/rankings/latest.json');
                const data = await response.json();

                const volumeTable = document.getElementById('volume-table');
                volumeTable.innerHTML = '';

                if (data.models) {
                    // Sort by volume
                    const sorted = Object.entries(data.models)
                        .sort((a, b) => b[1].tokens_weekly - a[1].tokens_weekly)
                        .slice(0, 10);

                    for (const [model, info] of sorted) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="model-name">${model.split('/').pop()}</td>
                            <td class="value-cell">${info.tokens_formatted}</td>
                            <td class="value-cell">${info.market_share_pct.toFixed(1)}%</td>
                        `;
                        volumeTable.appendChild(row);
                    }
                }
            } catch (error) {
                console.log('Rankings data not available:', error);
            }
        }

        loadMarketData();
        loadRankingsData();
    </script>
</body>
</html>
